; ---------------------------------------------------------------------
;
;
;   Macro for the datas reduction of MBP+D2O and MBP+H20  
;   To be used after the basic data reduction as made with "@reduce"
;
;
;  Last revised: JOR (ollivier@ill.eu), Mon Aug 31 16:37:07 CEST 2009
; ---------------------------------------------------------------------

RDSET,inst="IN5"            
;RDSET,base="Current Path"            

; ---------------------------------------------------------------------

s  = '1-16,357-362'     ; bad spectra numbers to remove... 
n  =  17                ; n grouping spectra
d  =  0.93              ; MBP + D2O transmission
h  =  0.91              ; MBP + H2O transmission
e  =  0.05				; Rebin to constant dE = e
q  =  0.1 				; Rebin to S(Q,w) grid for given dQ = q
f  =  -5 				; Emin = diocristi
v  =  0.890             ; vanadium transmission
c  = "sample.dat"       ; Name of the output file





; ---------------------------------------------------------------------
;
;   1)             Empty Cell 1 at 150 K
;
; ---------------------------------------------------------------------
; 1.1) load data (already normalized to monitor or time X 1000)
; ---------------------------------------------------------------------

w1 = rdrun('123460_123463.hdf')

; ---------------------------------------------------------------------
; 1.2) remove bad spectra
; ---------------------------------------------------------------------

w1 = in5_remove_spectra(w1,badSpectra=s, /verbose)





; ---------------------------------------------------------------------
;
;   2)             Empty Cell 4 at 297 K
;
; ---------------------------------------------------------------------
; 2.1) load data (not normalized to monitor)
; ---------------------------------------------------------------------

w2 = rdrun('123471_123472.hdf')

; ---------------------------------------------------------------------
; 2.2) remove bad spectra
; ---------------------------------------------------------------------

w2 = in5_remove_spectra(w2, badSpectra = s, /verbose)





; ---------------------------------------------------------------------
;
;   3)             Vanadium at 160 K
;
; ---------------------------------------------------------------------
; 3.1) load sample (already normalized to monitor or time X 1000)
; ---------------------------------------------------------------------

w3 = rdrun('123535_123536.hdf')

; ---------------------------------------------------------------------
; 3.2) remove bad spectra
; ---------------------------------------------------------------------

w3 = in5_remove_spectra(w3, badSpectra = s, /verbose)

; ---------------------------------------------------------------------
; 3.3) vanadium correction to empty cell
; ---------------------------------------------------------------------

w4 = w3 - v * w1
e4 = sqrt(e3^2 + (v * e1)^2)

; ---------------------------------------------------------------------
;  3.4) Correct for self-shielding/self-absorption
;  (VF. Sears like) for vanadium
;
; thick   = thickness
; angle   = slab angle
; rin     = cylinder inner radius [mm]
; rout    = cylinder outer radius [mm]
; sigma_a = absorption cross section
; sigma_s = total scattering cross section
; rho     = density
; Mass    = atomic mass
;
; ---------------------------------------------------------------------

w5 = in5_safcorr(w4, thick=1, angle=135.0, sigma_a=5.98, sigma_s=5.205, rho=5.96, Mass=50.941, /verbose)





; ---------------------------------------------------------------------
;
;   4)             MBP + H2O at 150 K
;
; ---------------------------------------------------------------------
; 5.1) load sample (already normalized to monitor or time X 1000)
; ---------------------------------------------------------------------

w6 = rdrun('123412_123422.hdf')

; ---------------------------------------------------------------------
; 4.2) remove bad spectra
; ---------------------------------------------------------------------

w6 = in5_remove_spectra(w6,badSpectra=s, /verbose)

; ---------------------------------------------------------------------
; 4.3) sample correction to empty cell
; ---------------------------------------------------------------------

w7 = w6 - h * w1 
e7 = sqrt(e6^2 + (h * e1)^2)

; ---------------------------------------------------------------------
;  4.4) Correct for self-shielding/self-absorption
;  (VF. Sears like) for sample
;
; thick   = thickness [mm]
; rin     = cylinder inner radius [mm]
; rout    = cylinder outer radius [mm]
; angle   = slab angle [deg]
; sigma_a = absorption cross section [barns]
; sigma_s = total scattering cross section [barns]
; rho     = density [g/cm^3]
; Mass    = atomic mass [g/mol]
;
; For a slab:
; ---------------------------------------------------------------------

w8 = in5_safcorr(w7, thick=0.023, angle=135.0, sigma_a=6160.37, sigma_s=336927, rho=1.4, Mass=54700, /verbose)

; ---------------------------------------------------------------------
;
; 4.5)  Normalize by the elastic peak of the vanadium          
;
;  
;   (vnorm correct the vana from DWF first.)
;
;
; ---------------------------------------------------------------------

w9 = in5_vnorm(w8, w5, /verbose)

; ---------------------------------------------------------------------
;
; 4.6) Correction for detector wavelength-efficiency +
;    remove flat bkgd.
;   /psd means take the same correction for all IN5 angles
;        that was not the case for the former IN5 with the 3 different
;        type of detectors - reduced to 2 in SAF corrections.
;   Other solution : mimic IN6 with rdset, inst="in6"
;                    Warning: for corrtof only.
;
; ---------------------------------------------------------------------

w9 = in5_corrtof(w9, /deteff, /psd, /background , /verbose)

; ---------------------------------------------------------------------
;
; 4.7) Conversion to S(2*theta, omega)
;
; ---------------------------------------------------------------------

w10 = in5_t2e(w9, /verbose)

; ---------------------------------------------------------------------
;
; 4.8) Rebin to constant dE = e 
;
; ---------------------------------------------------------------------

w11 = reb(w10, dE = e)

; ---------------------------------------------------------------------
;
; 4.9) Rebin to S(Q,w) grid for given dQ and minimum energy
;    
;
; ---------------------------------------------------------------------

w12 = sqw_rebin(w11, dQ = q, Emin = f)





; ---------------------------------------------------------------------
;
;   5)             MBP + D2O at 150 K
;
; ---------------------------------------------------------------------
; 5.1) load sample (already normalized to monitor or time X 1000)
; ---------------------------------------------------------------------

w13 = rdrun('123510_123522.hdf')

; ---------------------------------------------------------------------
; 5.2) remove bad spectra
; ---------------------------------------------------------------------

w13 = in5_remove_spectra(w13, badSpectra = s, /verbose)

; ---------------------------------------------------------------------
; 5.3) sample correction to empty cell
; ---------------------------------------------------------------------

w14 = w13 - d * w1 
e14 = sqrt(e13^2 + (d * e1)^2)

; ---------------------------------------------------------------------
; 5.4) Correct for self-shielding/self-absorption
;  (VF. Sears like) for sample
;
; thick   = thickness [mm]
; rin     = cylinder inner radius [mm]
; rout    = cylinder outer radius [mm]
; angle   = slab angle [deg]
; sigma_a = absorption cross section [barns]
; sigma_s = total scattering cross section [barns]
; rho     = density [g/cm^3]
; Mass    = atomic mass [g/mol]
;
; For a slab:
; ---------------------------------------------------------------------

w15 = in5_safcorr(w14, thick = 0.023, angle = 135.0, sigma_a = 4658.54, sigma_s = 217852, rho = 1.4, Mass = 56296, /verbose)


; ---------------------------------------------------------------------
;
; 5.5)  Normalize by the elastic peak of the vanadium          
;
;  
;   (vnorm correct the vana from DWF first.)
;
;
; ---------------------------------------------------------------------

w16 = in5_vnorm(w15, w5, /verbose)

; ---------------------------------------------------------------------
;
; 5.6) Correction for detector wavelength-efficiency +
;    remove flat bkgd.
;   /psd means take the same correction for all IN5 angles
;        that was not the case for the former IN5 with the 3 different
;        type of detectors - reduced to 2 in SAF corrections.
;   Other solution : mimic IN6 with rdset, inst="in6"
;                    Warning: for corrtof only.
;
; ---------------------------------------------------------------------

w16 = in5_corrtof(w16, /deteff, /psd, /background , /verbose)

; ---------------------------------------------------------------------
;
; 5.7) Conversion to S(2*theta, omega)
;
; ---------------------------------------------------------------------

w17 = in5_t2e(w16, /verbose)

; ---------------------------------------------------------------------
;
; 5.8) Rebin to constant dE = e
;
; ---------------------------------------------------------------------

w18 = reb(w17, dE = e)    

; ---------------------------------------------------------------------
;
; 5.9) Rebin to S(Q,w) grid for given dQ and minimum energy
;
; ---------------------------------------------------------------------

w19 = sqw_rebin(w18, dQ = q, Emin = f)





; ---------------------------------------------------------------------
;
;   6)             MBP + H2O at 297 K
;
; ---------------------------------------------------------------------
; 6.1) load sample (already normalized to monitor or time X 1000)
; ---------------------------------------------------------------------

w20 = rdrun('123400_123401.hdf')

; ---------------------------------------------------------------------
; 6.2) remove bad spectra
; ---------------------------------------------------------------------

w20 = in5_remove_spectra(w20,badSpectra=s, /verbose)

; ---------------------------------------------------------------------
; 6.3) sample correction to empty cell
; ---------------------------------------------------------------------

w21 = w20 - h * w2 
e21 = sqrt(e20^2 + (h * e2)^2)

; ---------------------------------------------------------------------
; 6.4) Correct for self-shielding/self-absorption
;  (VF. Sears like) for sample
;
; thick   = thickness [mm]
; rin     = cylinder inner radius [mm]
; rout    = cylinder outer radius [mm]
; angle   = slab angle [deg]
; sigma_a = absorption cross section [barns]
; sigma_s = total scattering cross section [barns]
; rho     = density [g/cm^3]
; Mass    = atomic mass [g/mol]
;
; For a slab:
; ---------------------------------------------------------------------

w22 = in5_safcorr(w21, thic = 0.023, angle = 135.0, sigma_a = 6160.37, sigma_s = 336927, rho = 1.4, Mass = 54700, /verbose)

; ---------------------------------------------------------------------
;
; 6.5)  Normalize by the elastic peak of the vanadium          
;
;  
;   (vnorm correct the vana from DWF first.)
;
;
; ---------------------------------------------------------------------

w23 = in5_vnorm(w22, w5, /verbose)

; ---------------------------------------------------------------------
;
; 6.6) Correction for detector wavelength-efficiency +
;    remove flat bkgd.
;   /psd means take the same correction for all IN5 angles
;        that was not the case for the former IN5 with the 3 different
;        type of detectors - reduced to 2 in SAF corrections.
;   Other solution : mimic IN6 with rdset, inst="in6"
;                    Warning: for corrtof only.
;
; ---------------------------------------------------------------------

w23 = in5_corrtof(w23, /deteff, /psd, /background , /verbose)

; ---------------------------------------------------------------------
;
; 6.7) Conversion to S(2*theta, omega)
;
; ---------------------------------------------------------------------

w24 = in5_t2e(w23, /verbose)

; ---------------------------------------------------------------------
;
; 6.8) Rebin to constant dE = e
;
; ---------------------------------------------------------------------
 
w25 = reb(w24, dE = e)                  

; ---------------------------------------------------------------------
;
; 6.9) Rebin to S(Q,w) grid for given dQ and minimum energy
;
; ---------------------------------------------------------------------

w26 = sqw_rebin(w25, dQ = q, Emin = f)





; ---------------------------------------------------------------------
;
;   7)             MBP + D2O at 297 K
;
; ---------------------------------------------------------------------
; 7.1) load sample (already normalized to monitor or time X 1000)
; ---------------------------------------------------------------------

w27 = rdrun('123497_123500.hdf')

; ---------------------------------------------------------------------
; 7.2) remove bad spectra
; ---------------------------------------------------------------------

w27 = in5_remove_spectra(w27, badSpectra = s, /verbose)

; ---------------------------------------------------------------------
; 7.3) sample correction to empty cell
; ---------------------------------------------------------------------

w28 = w27 - d * w2 
e28 = sqrt(e27^2 + (d * e2)^2)

; ---------------------------------------------------------------------
; 7.4) Correct for self-shielding/self-absorption
;  (VF. Sears like) for sample
;
; thick   = thickness [mm]
; rin     = cylinder inner radius [mm]
; rout    = cylinder outer radius [mm]
; angle   = slab angle [deg]
; sigma_a = absorption cross section [barns]
; sigma_s = total scattering cross section [barns]
; rho     = density [g/cm^3]
; Mass    = atomic mass [g/mol]
;
; For a slab:
; ---------------------------------------------------------------------

w29 = in5_safcorr(w28, thick = 0.023, angle = 135.0, sigma_a = 4658.54, sigma_s = 217852, rho = 1.4, Mass = 56296, /verbose)

; ---------------------------------------------------------------------
;
; 7.5)  Normalize by the elastic peak of the vanadium          
;
;  
;   (vnorm correct the vana from DWF first.)
;
;
; ---------------------------------------------------------------------

w30 = in5_vnorm(w29, w5, /verbose)

; ---------------------------------------------------------------------
;
; 7.6) Correction for detector wavelength-efficiency +
;    remove flat bkgd.
;   /psd means take the same correction for all IN5 angles
;        that was not the case for the former IN5 with the 3 different
;        type of detectors - reduced to 2 in SAF corrections.
;   Other solution : mimic IN6 with rdset, inst="in6"
;                    Warning: for corrtof only.
;
; ---------------------------------------------------------------------

w30 = in5_corrtof(w30, /deteff, /psd, /background , /verbose)

; ---------------------------------------------------------------------
;
; 7.7) Conversion to S(2*theta, omega)
;
; ---------------------------------------------------------------------

w31 = in5_t2e(w30, /verbose)

; ---------------------------------------------------------------------
;
; 7.8) Rebin to constant dE = e
;
; ---------------------------------------------------------------------
 
w32 = reb(w31, dE = e)                  

; ---------------------------------------------------------------------
;
; 7.9) Rebin to S(Q,w) grid for given dQ and minimum energy    
;
; ---------------------------------------------------------------------

w33 = sqw_rebin(w32, dQ = q, Emin = f)


w34 = w10
w35 = w11
w36 = w12

w37 = w17
w38 = w18
w39 = w19

w40 = w24
w41 = w25
w42 = w26

w43 = w31
w44 = w32
w45 = w33

; ---------------------------------------------------------------------
;
; S(Q,E) 
;
; ---------------------------------------------------------------------

w46 = w12		; MBP + H2O at 150 K
w47 = w19		; MBP + D2O at 150 K
w48 = w26		; MBP + H2O at 297 K
w49 = w33		; MBP + D2O at 297 K


; ---------------------------------------------------------------------
;
; g(E) in funz. anche dell'angolo 2theta
;
; ---------------------------------------------------------------------

w50 = gdos(w11)		; MBP + H2O at 150 K
w51 = gdos(w12)		; MBP + D2O at 150 K


;w42 = sqw_rebin(w11,dQ = .1)

;w38 = in5_group(w34,n,/verbose)
;w39 = in5_group(w35,n,/verbose)
;w40 = in5_group(w36,n,/verbose)
;w41 = in5_group(w37,n,/verbose)

;w38 = in5_energy_rebin(w38,de=0.02,Emin=-10.0,/force)
;w39 = in5_energy_rebin(w39,de=0.02,Emin=-10.0,/force)
;w40 = in5_energy_rebin(w40,de=0.02,Emin=-10.0,/force)
;w41 = in5_energy_rebin(w41,de=0.02,Emin=-10.0,/force)


